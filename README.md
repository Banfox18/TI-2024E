# 三子棋机器人项目说明

## 项目简介

本项目实现了一个基于 OpenMV + STM32 + 蓝牙通信的**三子棋（Tic-Tac-Toe）智能机器人系统**，集合了图像识别、最优走棋AI、串口/蓝牙通信与机械臂控制。可在自动识别棋盘与棋子、接收用户指令的基础上，实现机械臂自主落子，具备完整的人机对弈与自动判局能力。

---

## 硬件与环境要求

- **OpenMV Cam H7 或支持的 OpenMV 系列摄像头**
- **STM32 系列单片机（与OpenMV串口通信）**
- **机械臂（6自由度舵机驱动）**
- **带蓝牙（HC-05/06等）的串口模块，用于无线遥控与指令下发**
- **Python 3.x，OpenMV IDE（脚本开发与调试）**
- **相关依赖库**（如`pyb`, `ustruct`, `image`，均为 OpenMV/STM32 环境自带）

---

## 文件结构说明

```plaintext
.
├── main.py           # 主程序入口/循环，负责视图、通信、流程主控
├── board.py          # 棋盘与AI逻辑（判局、AI决策、辅助函数）
├── target.py         # 图像识别相关函数（棋盘格、棋子识别、坐标映射）
├── ttl.py            # 通信/舵机指令封装及解析
├── README.md         # 项目说明文件
```

---

## 主要功能模块

### main.py

- **图像识别初始化**（OpenMV sensor参数配置，包括色彩阈值、窗口、曝光等）
- **棋盘、棋子识别**（调用`findBlob`，识别9宫格与棋子位置）
- **串口与蓝牙通信管理**（UART1蓝牙/UART3与STM32通信）
- **对局流程控制**（根据蓝牙指令/棋盘实际变化调用机械臂进行移动）

### board.py

- **棋盘比对与差分检测**（`detectMove`：检测实际落子是否发生、座标变化）
- **胜负判定**（`checkWinner`，横纵/对角线判断）
- **AI最优决策（minimax算法）**（`findBestMove`，含阻挡与速胜判据）
- **棋盘状态判断**（是否满盘，是否空盘等）

### target.py

- **棋盘格点定位**（`findRects`、`findRectsCenters`：找到格子角点与中心点）
- **棋子图片区域识别**（`findChess`：预处理中区分黑/白棋目信息）
- **坐标映射**（像素点与棋盘行列对应）

### ttl.py

- **数据收发封装**（`sendCommand`、`sendData`、`sendDataToBlueTooth`）
- **蓝牙指令解析**（`convertCommand`，支持1-9、A、B、C-K等指令协议）
- **机械臂动作映射**（棋盘座标与舵机动作指令映射表）
- **AI落子调用与指令链式发送**

---

## 指令协议说明

- **蓝牙指令**
  - `1`-`9`：落子指定格（ASCII 49-57）
  - `A/B`：由AI执黑/执白（A=65, B=66）
  - `C`-`K`：拓展指令，保留
- **行进动作**
  - 每一步棋包含“夹取”+“放置”两个指令，通过串口封装发送
- **串口命令格式**
  - 如 `$DGT:48-52,1!`，代表机械臂运行编号区间的预设动作
  - 棋盘坐标与动作编号一一映射，靠`posToIndex`等函数生成

---

## 快速运行说明

1. **硬件准备：**  
   将 OpenMV 摄像头对准实体三子棋棋盘，正确连接 STM32、机械臂和蓝牙模块。

2. **程序下载：**  
   用 OpenMV IDE 下载/烧录 `main.py` 及其他脚本到 OpenMV，确保所有 py 文件在同一目录下。

3. **蓝牙/串口配置：**  
   - UART1：蓝牙（9600bps）
   - UART3：STM32 串口通信（115200bps）

4. **对局流程：**  
   - 电脑或手机APP 通过蓝牙发送指令；
   - 系统自动检测棋盘、识别棋子、计算AI最优落子，然后驱动机械臂执行实际落子；
   - 全程状态输出于OpenMV串口，便于调试。

---

## 开发与调试建议

- **建议逐步注释调试每一部分，先看图像识别能否识别各点与棋子，再联调通信。**
- **可使用虚拟串口助手先模拟蓝牙通信内容。**
- **如棋盘识别效果不好，建议微调阈值与ROI位置。**
- **需注意舵机编号与动作脚本需与物理机械臂运动一一对应。**

---

## 常见问题与FAQ

- 识别不到棋子？
  - 检查阈值设定、光线条件、棋盘ROI。
- 机械臂落子/夹子不准？
  - 确认舵机编号与动作表一致，可手动调整映射表。
- 无法串口通信？
  - 确认串口连接电平、波特率设置、线序无误，必要时用OpenMV串口台调试。

---

## License

本项目开源用于学习/交流，禁止用于商业用途。如需引用或开发衍生版请联系原作者。

---

> 如对项目有疑问或需扩展功能，欢迎提交 Issue 或与作者联系！
